library(dplyr)
library(stringr)
library(biomaRt)
library(dplyr)
library(tibble)
library(tximport)
library(tidyverse)
library(fs)
library(here)

# Install biomaRt if you haven't already
if (!requireNamespace("biomaRt", quietly = TRUE)) {
  install.packages("biomaRt")  # For CRAN version
  # or use Bioconductor for the latest version:
  # if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
  # BiocManager::install("biomaRt")
}

# Load the package
library(biomaRt)

# Connect to the human Ensembl mart
mart <- useMart(
  "ENSEMBL_MART_ENSEMBL",
  dataset = "hsapiens_gene_ensembl"
)

# Get transcript-to-gene mapping
t2g <- getBM(
  attributes = c(
    "ensembl_transcript_id",
    "ensembl_gene_id",
    "external_gene_name"
  ),
  mart = mart
) %>%
  as_tibble()

# Map systematic IDs to common gene names
gene_name_map <- t2g %>%
  dplyr::select(-ensembl_transcript_id) %>%
  unique() %>%
  mutate(external_gene_name = ifelse(
    external_gene_name == "", ensembl_gene_id, external_gene_name
  ))


# Load metadata
metadata <- tibble(
  salmon_dirs = fs::dir_ls(
    here("data/block-rna/differentiation_salmonouts"),
    recurse = TRUE,
    glob = "*quant.sf"
  )
) %>%
  mutate(sample_id = fs::path_file(fs::path_dir(salmon_dirs))) %>%
  filter(str_starts(sample_id, "DIV")) %>%
  separate_wider_delim(
    col = sample_id,
    delim = ".",
    names = c("timepoint", "rep"),
    too_few = "align_start",
    cols_remove = FALSE
  ) %>%
  mutate(rep = str_remove(rep, "Rep")) %>%
  column_to_rownames("sample_id")

# Add sample_id back
metadata$sample_id <- rownames(metadata)

# Keep only desired timepoints
metadata <- metadata %>%
  filter(timepoint %in% c("DIV0", "DIV7"))

# Prepare salmon directories vector for tximport
salmdir <- metadata$salmon_dirs
names(salmdir) <- metadata$sample_id

# Make tx2gene table compatible with tximport
# tximport expects columns: transcript (tx), gene (gene)
tx2gene <- gene_name_map %>%
  rename(tx = ensembl_transcript_id, gene = external_gene_name)

# Import with tximport
txi <- tximport(
  files = salmdir,
  type = "salmon",
  tx2gene = tx2gene,
  dropInfReps = TRUE,
  countsFromAbundance = "lengthScaledTPM"
)





library(GEOquery)
library(dplyr)
library(stringr)

# Load GEO dataset
gse <- getGEO("GSE175809", GSEMatrix = TRUE)[[1]]

pdata <- pData(gse)

# Define the GSMs you care about
selected_gsms <- c(
  "GSM5348316", "GSM5348317", "GSM5348318", 
  "GSM5348319", "GSM5348310", "GSM5348311"
)

# Subset pdata and add TGFb info
TGFb_data <- pdata %>%
  filter(geo_accession %in% selected_gsms) %>%
  mutate(
    TGFb_treatment = if_else(str_detect(title, "TGFB"), "TGFb", "No_TGFb")
  ) %>%
  dplyr::select(
    geo_accession, title, cell_line = `cell line:ch1`,
    condition = `condition:ch1`, stage = `developmental stage:ch1`,
    TGFb_treatment
  )

TGFb_data












# ---- Load GEO dataset ----
gse <- getGEO("GSE175809", GSEMatrix = TRUE)[[1]]

pdata <- pData(gse)


TGFb_data <- pdata %>%
  mutate(
    TGFb_treatment = if_else(str_detect(title, "TGFB"), "TGFb", "No_TGFb")
  )












































library(tidyverse)
library(DESeq2)
library(tidyverse)


library(biomaRt)
library(dplyr)
library(tibble)

mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

gene_name_map <- getBM(
  attributes = c("ensembl_gene_id", "external_gene_name"),
  filters = "ensembl_gene_id",
  values = rownames(count_matrix_filtered),
  mart = mart
) %>%
  as_tibble()



file_path <- "/Users/raileymikeska/Downloads/GSE175809_hiNCC_featureCounts.txt"

# Read the counts, skipping the first comment line
counts_raw <- read.delim(
  file_path,
  comment.char = "#",      # skip the first line starting with '#'
  check.names = FALSE,
  stringsAsFactors = FALSE
)

# Keep only the count columns (after 'Length')
count_matrix <- counts_raw %>%
  dplyr::select(-(Chr:Length)) %>%       # remove metadata columns
  column_to_rownames("Geneid")    # set gene IDs as rownames

# Fix sample column names (strip out "../bam/" and "_hg38.bam")
colnames(count_matrix) <- colnames(count_matrix) %>%
  str_replace_all("../bam/", "") %>%
  str_replace_all("_hg38.bam", "")

# Check
head(count_matrix)



library(tibble)
library(dplyr)
library(stringr)

# Extract sample names from count matrix
sample_names <- colnames(count_matrix)

# Create a metadata table for DESeq2
metadata <- tibble(
  sample_id = sample_names
) %>%
  mutate(
    TGFb_treatment = if_else(str_detect(sample_id, "TGFB"), "TGFb", "No_TGFb"),
    Wnt_condition = if_else(str_detect(sample_id, "highWNT"), "highWnt", "lowWnt"),
    Induction = if_else(str_detect(sample_id, "NoInd"), "NoInduction", "hiNCC_Day5")
  )

# Check
metadata


metadata <- metadata %>%
  mutate(
    TGFb_treatment = factor(TGFb_treatment),
    Wnt_condition  = factor(Wnt_condition),
    Induction      = factor(Induction)
  )



# Examine distribution of counts across all genes
hist(log2(1 + rowSums(count_matrix)), breaks = 40,
     main = "Distribution of log2 total counts per gene",
     xlab = "log2(1 + total counts)")

# Decide a cutoff and keep genes above it
keep_genes <- rownames(count_matrix)[log2(1 + rowSums(count_matrix)) > 4.5]

# Filter count_matrix
count_matrix_filtered <- count_matrix[keep_genes, ]

# Check
dim(count_matrix_filtered)
head(count_matrix_filtered)


library(DESeq2)

dds <- DESeqDataSetFromMatrix(
  countData = count_matrix_filtered,
  colData = metadata,
  design = ~ TGFb_treatment + Wnt_condition
)

# Run DESeq
dds <- DESeq(dds)

# Inspect results
dds

library(dplyr)
library(tibble)

diff_tgf <-
  results(
    dds,
    contrast = c("TGFb_treatment", "TGFb", "No_TGFb")
  ) %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene") %>%   # rownames ARE gene symbols
  as_tibble() %>%
  dplyr::select(-c(baseMean, lfcSE, stat, pvalue))


# number of upregulated genes
nrow(filter(diff_tgf, padj < 0.01 & log2FoldChange > 0))

# number of downregulated genes
nrow(filter(diff_tgf, padj < 0.01 & log2FoldChange < 0))



# meets the FDR cutoff
diff_sig <-
  mutate(
    diff_tgf,
    sig = case_when(
      padj < 0.01 ~ "yes",
      .default = "no"
    )
  ) |>
  # if a gene did not meet expression cutoffs that DESeq2 automatically does, it gets a pvalue of NA
  drop_na()

library(ggrepel)  # for non-overlapping labels

library(ggplot2)
library(ggrepel)
library(cowplot)
library(dplyr)


# Your tubulin genes
tubulin_genes <- c(
  "TUBB1", "TUBB2A", "TUBB2B", "TUBB3", "TUBB4", "TUBB5", "TUBB6",
  "TUBA1A", "TUBA1B", "TUBA1C", "TUBA3A", "TUBA4A", "TUBA8"
)

# Convert both to uppercase
diff_sig <- diff_sig %>% mutate(gene_upper = toupper(gene))
tubulin_genes_upper <- toupper(tubulin_genes)

# Volcano plot
ggplot(diff_sig, aes(x = log2FoldChange, y = -log10(padj), color = sig)) +
  geom_point(alpha = 0.3) +
  geom_text_repel(
    data = subset(diff_sig, grepl("TUBB|TUBA", gene, ignore.case = TRUE)),
    aes(label = gene),
    size = 3,
    segment.alpha = 0.5,
    max.overlaps = 50
  ) +
  labs(
    x = "log2 Fold Change (TGFβ / No TGFβ)",
    y = "-log10(FDR)"
  ) +
  scale_color_manual(
    values = c("black", "red"),
    labels = c("NS", "FDR < 0.01"),
    name = ""
  ) +
  theme_cowplot() +
  theme(legend.position = "top")










library(DESeq2)
library(dplyr)
library(tibble)
library(ggplot2)
library(cowplot)

# -------------------------------
# 1. Get results with ≥3-fold change
# -------------------------------
diff_lfc_tgf <-
  results(
    dds,
    contrast = c("TGFb_treatment", "TGFb", "No_TGFb"),
    lfcThreshold = log2(2)   # 2-fold change
  ) %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene") %>%  # rownames are already gene symbols
  as_tibble() %>%
  dplyr::select(-c(baseMean, lfcSE, stat, pvalue))  # remove unnecessary DESeq2 columns

# -------------------------------
# 2. Flag significant genes (FDR < 0.01)
# -------------------------------
diff_lfc_tgf <- diff_lfc_tgf %>%
  mutate(
    sig = case_when(
      padj < 0.01 ~ "yes",
      TRUE ~ "no"
    )
  ) %>%
  drop_na()  # remove genes with NA p-values

# -------------------------------
# 3. Count significant genes
# -------------------------------
# Up in TGFβ-treated
n_up <- sum(diff_lfc_tgf$padj < 0.01 & diff_lfc_tgf$log2FoldChange > 0)
# Down in TGFβ-treated
n_down <- sum(diff_lfc_tgf$padj < 0.01 & diff_lfc_tgf$log2FoldChange < 0)

n_up
n_down

# -------------------------------
# 4. Volcano plot
# -------------------------------
ggplot(
  diff_lfc_tgf,
  aes(
    x = log2FoldChange,
    y = -log10(padj),
    color = sig
  )
) +
  geom_point(alpha = 0.2) +
  labs(
    x = "TGFβ expression / No TGFβ expression, log2",
    y = "-log10(FDR)"
  ) +
  scale_color_manual(
    values = c("black", "red"),
    labels = c("NS", "FDR < 0.01"),
    name = ""
  ) +
  theme_cowplot()

























diff_lfc_tgf <- results(dds, contrast = c("TGFb_treatment", "TGFb", "No_TGFb")) %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  as_tibble() %>%
  select(-c(baseMean, lfcSE, stat, pvalue)) %>%
  drop_na() %>%
  mutate(
    sig = case_when(
      padj < 0.01 & abs(log2FoldChange) >= log2(2) ~ "yes",
      TRUE ~ "no"
    )
  )



install.packages("gt")


library(dplyr)
library(gt)

# -------------------------------
# 1. Flag significant genes (FDR < 0.01)
# -------------------------------
diff_lfc_sig <- diff_lfc %>%
  mutate(
    sig = case_when(
      padj < 0.01 ~ "yes",
      TRUE ~ "no"
    )
  ) %>%
  drop_na()  # remove genes with NA p-values


library(ggrepel)

ggplot(diff_lfc_sig, aes(
  x = log2FoldChange,
  y = -log10(padj),
  color = sig
)) +
  geom_point(alpha = 0.2) +
  # Add labels only for significant genes
  geom_text_repel(
    data = subset(diff_lfc_sig, sig == "yes"),
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  labs(
    x = "DIV7 expression / DIV0 expression, log2",
    y = "-log10(FDR)"
  ) +
  scale_color_manual(
    values = c("black", "red"),
    labels = c("NS", "FDR < 0.01"),
    name = ""
  ) +
  theme_cowplot()


























library(DESeq2)
library(dplyr)
library(tibble)
library(ggplot2)
library(ggrepel)
library(cowplot)

# ------------------------------
# Subset metadata for high and low Wnt
# ------------------------------
metadata_high <- metadata %>% 
  filter(Wnt_condition == "highWnt") %>%
  filter(!str_detect(sample_id, "_SB4_"))

metadata_low <- metadata %>% 
  filter(Wnt_condition == "lowWnt") %>%
  filter(!str_detect(sample_id, "_SB4_"))


# Subset count matrix to match columns
count_high <- count_matrix_filtered[, colnames(count_matrix_filtered) %in% metadata_high$sample_id]
count_low  <- count_matrix_filtered[, colnames(count_matrix_filtered) %in% metadata_low$sample_id]



metadata_high
metadata_low
colnames(count_high)
colnames(count_low)



# ------------------------------
# Run DESeq2 for high Wnt cells
# ------------------------------
dds_high <- DESeqDataSetFromMatrix(
  countData = count_high,
  colData = metadata_high,
  design = ~ TGFb_treatment
)
dds_high <- DESeq(dds_high)
res_high <- results(dds_high, contrast = c("TGFb_treatment", "TGFb", "No_TGFb")) %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene") %>%
  as_tibble() %>%
  mutate(sig = if_else(padj < 0.01, "yes", "no"))

# ------------------------------
# Run DESeq2 for low Wnt cells
# ------------------------------
dds_low <- DESeqDataSetFromMatrix(
  countData = count_low,
  colData = metadata_low,
  design = ~ TGFb_treatment
)
dds_low <- DESeq(dds_low)
res_low <- results(dds_low, contrast = c("TGFb_treatment", "TGFb", "No_TGFb")) %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene") %>%
  as_tibble() %>%
  mutate(sig = if_else(padj < 0.01, "yes", "no"))

# ------------------------------
# Volcano plot function
# ------------------------------
# Volcano plot function with highlighted tubulin genes (colored by sig)
plot_volcano <- function(diff_df, title) {
  
  # Identify tubulin genes
  tub_genes <- subset(diff_df, grepl("TUBB|TUBA", gene, ignore.case = TRUE))
  other_genes <- subset(diff_df, !grepl("TUBB|TUBA", gene, ignore.case = TRUE))
  
  ggplot() +
    # Plot all non-tubulin genes faintly
    geom_point(data = other_genes, 
               aes(x = log2FoldChange, y = -log10(padj), color = sig), 
               alpha = 0.2, size = 1.5) +
    
    # Plot tubulin genes bigger, outlined
    geom_point(data = tub_genes, 
               aes(x = log2FoldChange, y = -log10(padj), color = sig), 
               shape = 21, size = 5, stroke = 1.2, fill = "white") +
    
    # Add labels for tubulin genes
    geom_text_repel(data = tub_genes,
                    aes(x = log2FoldChange, y = -log10(padj), label = gene),
                    size = 6, segment.alpha = 0.5, max.overlaps = 50) +
    
    labs(
      x = "log2 Fold Change (TGFβ / No TGFβ)",
      y = "-log10(FDR)",
      title = title
    ) +
    
    scale_color_manual(values = c("black", "red"), labels = c("NS", "FDR < 0.01"), name = "") +
    
    theme_cowplot() +
    theme(legend.position = "top")
}

# Example usage
volcano_high <- plot_volcano(res_high, "High Wnt cells")
volcano_low  <- plot_volcano(res_low, "Low Wnt cells")

cowplot::plot_grid(volcano_high, volcano_low, ncol = 2)





